---
title: "Generation of the Figures for the DL Nuclear Segmentation Manuscript"
date: "Apr 8 2020"
authors: "Gianluca Pegoraro/George Zaki, NCI/NIH"
output: github_document
---

### Analysis initialization
Load the required libraries
```{r}
library(tidyverse)
library(readr)
library(curl)
library(ggthemes)
```

Set `knitr` and `ggplot2` options.
```{r}
knitr::opts_chunk$set(
    cache = FALSE,
    fig.path = "Output/",
    message = FALSE,
    warning = FALSE
    )

theme_set(theme_bw())

theme_update(
  axis.text.x = element_text(
    angle = -45,
    hjust = 0,
    vjust = 0.5
  ),
  axis.text.y = element_text(hjust = 0)
)
```

### Read and process data and metadata
Define a function to calculate the F1 score based on the number of true positives, false positives and false negatives.
```{r}
calculate_F1 <- function(tp, fn, fp){
  tp/(tp + (fn + fp)/2)
}
```

Download unzip the input results of the inference experiments from Figshare.
```{r}
URL <- "https://ndownloader.figshare.com/files/22184748"  
curl_download(URL, "data.zip")
unzip("data.zip")
```

Recursively read ands process all the data from all the paper runs. 
```{r message=FALSE}
raw_tbl <- dir(path = "Data", 
               pattern = ".*\\.csv$", 
               recursive = TRUE,
               full.names = TRUE) %>%
  set_names() %>%
  map_df(read_csv, .id = "filename") %>%
  select(filename, 
         thres = `IoU(Threshold)`,
         TP = `Sum(all_tp)`,
         FP = `Sum(all_fp)`,
         FN = `Sum(all_fn)`,
         mAP = AP) %>%
  mutate(F1 = calculate_F1(tp = TP,
                           fn = FN,
                           fp = FP))
```

```{r}
glimpse(raw_tbl)
```

Recode the values of the `cell_line` variable to make them compatible with the actual cell names used in the experiments.  
```{r}
levs1 <- c("MCF10A", "U2OS", "HCT116", "Eosinophils")
levs2 <- c("Original", "Technical", "Biological")

raw_tbl <- raw_tbl %>%
           mutate(filename = str_replace(filename, "BABE", "MCF10A"),
                    filename = str_replace(filename, "HiTIF_Colorectal", "HCT116"),
                    filename = str_replace(filename, "HiTIF_Laurent", "U2OS"),
                    filename = str_replace(filename, "Manasi", "Eosinophils"),
                    run = as.numeric(str_match(filename, pattern = "run([0-9]{3})")[,2]),
                    cell_line = str_match(filename, pattern = "Data/.*?/.*?/.*?/(.*?)_.*?/")[,2],
                    replicate = str_match(filename, pattern = "Data/.*?/.*?/.*?/.*?_(.*?)/")[,2],
                    cell_line = factor(cell_line, levels = levs1),
                    replicate = factor(replicate, levels = levs2))

glimpse(raw_tbl)
```

Read the run metadata table.
```{r}
md_tbl <- read_csv("Metadata/Metadata.csv")

glimpse(md_tbl)
```

```{r}
md_explore <- md_tbl %>% select(model, initialization, train_set, train_size, epochs, aug, run) %>%
  arrange(model, initialization, train_set, train_size, epochs, aug, run)
```


Reorder some factors and join the data table with the metadata table. 
```{r}
levs3 <- c("Random", "Pre-initialized")
levs4 <- c("MCF10A","Eosinophils", "MCF10A_HCT116", "MCF10A_HCT116_U2OS", "All", "BBBC038")
levs5 <- c("MRCNN", "FPN2-WS", "Jacobkie", "Kaggle_5th")


scores_tbl <- raw_tbl %>% 
           left_join(md_tbl, by = c("run")) %>%
           mutate(initialization = factor(initialization, levels = levs3),
                  train_set = factor(train_set, levels = levs4),
                  train_size = factor(train_size),
                  run = factor(run),
                  aug = factor(aug),
                  epochs = factor(epochs),
                  model = factor(model, levels = levs5)) %>%
           filter(replicate != "Original" ) %>%
           filter(!(cell_line == "MCF10A" & replicate == "Technical"))

glimpse(scores_tbl)
```

Create a summary of the annotated data table.
```{r}
summary(scores_tbl)
```

Plot the baseline model training performance using only MCF10A cells images for training and random weights (Fig. 2B).
```{r Fig2B, echo = F}
fig_2B <- scores_tbl %>% filter(run %in% c(3, 4))

scores_plot <- ggplot(fig_2B, aes(x = thres, 
                                 y = F1,
                                 color = cell_line))

scores_plot + geom_line() +
  geom_vline(xintercept = 0.7, 
             linetype = "longdash",
             color = "grey60") +
  facet_wrap(~ model) +
  scale_linetype_discrete("Replicate") +
  scale_color_few(name= "Cell Line") +
  xlab("IoU Threshold") +
  ylab("F1 Score")
```

Select and plot only the F1 values for IoU = 0.7 (As in [the KAGGLE '18 nucleus challenge paper](https://paperpile.com/shared/xZiVUo)).
```{r zeroSevenFilter}
F1_07_tbl <- scores_tbl %>%
             filter(round(thres, digits = 2) == 0.70)
```

Create a subset of experiments for the inizialization tests runs.
```{r InizializationSet}
initialization_set <- F1_07_tbl %>% filter(run %in% c(1, 3, 4, 5))
```

Plot only the effect of initialization (Fig. 3A).
```{r Fig3A,echo=F}
initialization_plot <- ggplot(initialization_set, 
                               aes(x = initialization,
                               y = F1,
                               color = model))

initialization_plot+ geom_point(alpha = 0.7,
                                 size = 3) +
                  scale_y_continuous(lim = c(0, 1.05), breaks = seq(0, 1, 0.1)) +
                  scale_color_few(name = "Model") +
                  facet_wrap(~ cell_line, nrow = 1) +
                  xlab("Inizialization") +
                  ylab("F1 Score @ IoU 0.7")
```

Create a subset of experiments for the incremental training strategy experiments (Fig.3B).
```{r TrainingSet}
training_set <- F1_07_tbl %>% filter(run %in% c(1, 5, 6, 10, 29, 30, 65, 66))
```
Plot only the effect of incremental training (Fig. 3B).
```{r Fig3B, echo = F}
trainingset_plot <- ggplot(training_set, 
                                 aes(x = train_set,
                                 y = F1,
                                 color = model))

trainingset_plot + geom_point(alpha = 0.7,
                                    size = 3) +
                  scale_y_continuous(lim = c(0, 1.05), breaks = seq(0, 1, 0.1)) +
                  scale_color_few(name = "Model") +
                  facet_wrap(~ cell_line, nrow = 1) +  
                  xlab("Training\nSet") +
                  ylab("F1 Score @ IoU 0.7")
```
Create a subset of experiments for the incremental length of training  experiments (Fig.4A).
```{r EpochsSet}
epochs_set <- F1_07_tbl %>% filter(run %in% c(6, 10, 12, 16, 17, 18, 67, 68))
```
Plot only the effect of incremental length of training (Fig. 4A).
```{r Fig4A, echo=F}
epochs_plot <- ggplot(epochs_set, aes(x = epochs,
                         y = F1,
                         color = model))

epochs_plot + geom_point(alpha = 0.7,
                               size = 3) +
                  scale_y_continuous(lim = c(0,1), breaks = seq(0, 1, 0.1)) +
                  scale_color_few(name = "Model") +
                  facet_wrap(~ cell_line, nrow = 1) +
                  xlab("Number of Training Cycles") +
                  ylab("F1 Score @ IoU 0.7")
```
Create a subset of experiments for the incremental size of the training set experiments (Fig.4B).
```{r TrainSizeSet}
train_size_set <- F1_07_tbl %>% filter(run %in% c(6, 10, 11, 19, 20, 45:49))
```
Plot only the effect of incremental size of the training set (Fig. 4B).
```{r Fig4B, echo=F}
train_size_plot <- ggplot(train_size_set, aes(x = train_size,
                         y = F1,
                         color = model))

train_size_plot + geom_point(alpha = 0.7,
                             size = 3) +
                  scale_y_continuous(lim = c(0,1), breaks = seq(0, 1, 0.1)) +
                  scale_color_few(name = "Model") +
                  facet_wrap(~ cell_line, nrow = 1) +
                  xlab("Training Set Size") +
                  ylab("F1 Score @ IoU 0.7")
```
Create a subset of experiments for different augmentations experiments (Fig.4C).
```{r AugSet} 
aug_set <- F1_07_tbl %>% filter(run %in% c(6, 10, 22:25, 27, 62, 69:72))
```
Plot only the effect of changing the augmentation strategies (Fig. 4C).
```{r Fig4C, echo=F}
aug_plot <- ggplot(aug_set, aes(x = aug,
                                y = F1,
                                color = model))

aug_plot + geom_point(alpha = 0.7,
                            size = 3) +
                  scale_y_continuous(lim = c(0,1), breaks = seq(0, 1, 0.1)) +
                  scale_color_few(name = "Model") +
                  facet_wrap(~ cell_line, nrow = 1) +
                  xlab("Augmentation") +
                  ylab("F1 Score @ IoU 0.7")
```

Create a subset of experiments for different augmentations experiments and inizializations (Fig.4D).
```{r RepeatsSet}
repeats_set <- F1_07_tbl %>% filter(run %in% c(6, 8, 10, 26, 32, 33:43, 50:64, 73:83))
```
Plot only the effect of changing the augmentation strategies and inizializations (Fig. 4D).
```{r Fig4D, echo = F}
repeats_plot <-
  ggplot(repeats_set, aes(
    x = interaction(aug, initialization, sep = "/"),
    y = F1,
    color = model
  ))

repeats_plot + geom_point(alpha = 0.7,
                          size = 2) +
  stat_summary(
    fun.data = "mean_cl_normal",
    geom = "crossbar",
    width = 0.5
  ) +
  scale_y_continuous(lim = c(0, 1), breaks = seq(0, 1, 0.1)) +
  scale_color_few(name = "Model") +
  facet_wrap(~ cell_line, nrow = 1) +
  xlab("Augmentation/Initialization") +
  ylab("F1 Score @ IoU 0.7,\nMean and 95% CI")
```
Plot the performance for the final MRCNN and FPN2-WS models comparing it with Jacobkie (Run044). This is Fig. 5B.
```{r Fig5B, echo = F}
fig_5B_set <- scores_tbl %>% filter(run %in% c(10, 37, 44))

fig_5B_plot <- ggplot(fig_5B_set, aes(x = thres, 
                                 y = F1,
                                 color = cell_line))

fig_5B_plot + geom_line() +
  geom_vline(xintercept = 0.7, 
             linetype = "longdash",
             color = "grey60") +
  facet_wrap(~ model) +
  scale_linetype_discrete("Replicate") +
  scale_color_few(name= "Cell Line") +
  xlab("IoU Threshold") +
  ylab("F1 Score")
```

```{r sessionInfo, results='markup'}
sessionInfo()
```