---
title: "Generation of Tables 1 to 8 and Table S3 and S4 for the DL Nuclear Segmentation Manuscript"
date: "September 30 2020"
authors: "Gianluca Pegoraro/George Zaki, NCI/NIH"
output: html_document
---

### Initialization
Load the required libraries
```{r import-libraries}
library(tidyverse)
library(readr)
library(knitr)
library(kableExtra)
```

Set `knitr` options.
```{r set-knitr-options}
knitr::opts_chunk$set(
    cache = FALSE,
    message = FALSE,
    warning = FALSE
    )
```

### Read Tables
Read the `.csv` tables generated by the `DL_Nuc_Seg_Results.Rmd` analysis script.
```{r read-data, message=FALSE}
table_1 <- read_csv("Output/Table1.csv")
table_2 <- read_csv("Output/Table2.csv")
table_3 <- read_csv("Output/Table3.csv")
table_4 <- read_csv("Output/Table4.csv")
table_5 <- read_csv("Output/Table5.csv")
table_6 <- read_csv("Output/Table6.csv")
table_7 <- read_csv("Output/Table7.csv")
table_8 <- read_csv("Output/Table8.csv")

table_S1 <- read_csv("Output/cell-properties.csv")
table_S3 <- read_csv("Output/TableS3.csv")
table_S4 <- read_csv("Output/TableS4.csv")
```

### Reformat Tables
Rearrange the Table 1 to have cell lines and F1 thresholds as columns and models and GT labels annotation strategies as rows.
```{r reformat-table1}
table_1_reformat <- table_1 %>%
  rename(
    `Cell Line` = cell_line,
    `MRCNN_0.7` = `MRCNN-0.7`,
    `MRCNN_0.9` = `MRCNN-0.9`,
    `FPN2-WS_0.7` = `FPN2-WS-0.7`,
    `FPN2-WS_0.9` = `FPN2-WS-0.9`
  ) %>%
  pivot_longer(
    cols = -`Cell Line`,
    names_sep = "_",
    names_to = c("Model", "Threshold"),
    values_to = "F1 Score"
  ) %>%
  pivot_wider(
    names_from = c(`Cell Line`, `Threshold`),
    values_from = `F1 Score`,
    names_sep = "/"
  ) %>%
  arrange(Model)
```

Same as above, but for Table 2.
```{r reformat-table2}
levs1 <- c("Random", "Pre-initialized")

table_2_reformat <- table_2 %>%
  rename(
    `Cell Line` = cell_line,
    `MRCNN_Random` = `MRCNN-Random`,
    `MRCNN_Pre-initialized` = `MRCNN-Pre-initialized`,
    `FPN2-WS_Random` = `FPN2-WS-Random`,
    `FPN2-WS_Pre-initialized` = `FPN2-WS-Pre-initialized`
  ) %>%
  pivot_longer(
    cols = -`Cell Line`,
    names_sep = "_",
    names_to = c("Model", "Initialization"),
    values_to = "F1 Score"
  ) %>%
  pivot_wider(
    names_from = `Cell Line`,
    values_from = `F1 Score`,
  ) %>%
  mutate(Initialization = factor(Initialization, levels = levs1)) %>%
  arrange(Model, Initialization)
```

Same as above, but for Table 3.
```{r reformat-table3}
levs2 <- c("MCF10A", 
           "MCF10A-HCT116", 
           "MCF10A-HCT116-U2OS", 
           "All")

table_3_reformat <- table_3 %>%
  rename(
    `Cell Line` = cell_line,
    `MRCNN_MCF10A` = `MRCNN-MCF10A`,
    `MRCNN_MCF10A-HCT116` = `MRCNN-MCF10A_HCT116`,
    `MRCNN_MCF10A-HCT116-U2OS` = `MRCNN-MCF10A_HCT116_U2OS`,
    `MRCNN_All` = `MRCNN-All`,
    `FPN2-WS_MCF10A` = `FPN2-WS-MCF10A`,
    `FPN2-WS_MCF10A-HCT116` = `FPN2-WS-MCF10A_HCT116`,
    `FPN2-WS_MCF10A-HCT116-U2OS` = `FPN2-WS-MCF10A_HCT116_U2OS`,
    `FPN2-WS_All` = `FPN2-WS-All`,
  ) %>%
  pivot_longer(
    cols = -`Cell Line`,
    names_sep = "_",
    names_to = c("Model", "Training Set"),
    values_to = "F1 Score"
  ) %>%
  pivot_wider(
    names_from = `Cell Line`,
    values_from = `F1 Score`,
  ) %>%
  mutate(`Training Set` = factor(`Training Set`, levels = levs2)) %>%
  arrange(Model, `Training Set`)
```

Same as above, but for Table 4.
```{r reformat-table4}
table_4_reformat <- table_4 %>%
  select(
    `Cell Line` = cell_line,
    `MRCNN_0.25X` = `MRCNN-0.25X`,
    `MRCNN_0.5X` = `MRCNN-0.5X`,
    `MRCNN_0.75X` = `MRCNN-0.75X`,
    `MRCNN_1X` = `MRCNN-1X`,
    `FPN2-WS_0.25X` = `FPN2-WS-0.25X`,
    `FPN2-WS_0.5X` = `FPN2-WS-0.5X`,
    `FPN2-WS_0.75X` = `FPN2-WS-0.75X`,
    `FPN2-WS_1X` = `FPN2-WS-1X`
  ) %>%
  pivot_longer(
    cols = -`Cell Line`,
    names_sep = "_",
    names_to = c("Model", "Epochs"),
    values_to = "F1 Score"
  ) %>%
  pivot_wider(
    names_from = `Cell Line`,
    values_from = `F1 Score`,
  ) %>%
  arrange(Model, Epochs)
```

Same as above, but for Table 5.
```{r reformat-table5}
table_5_reformat <- table_5 %>%
  select(
    `Cell Line` = cell_line,
    `MRCNN_0.125X` = `MRCNN-0.125X`,
    `MRCNN_0.25X` = `MRCNN-0.25X`,
    `MRCNN_0.5X` = `MRCNN-0.5X`,
    `MRCNN_1X` = `MRCNN-1X`,
    `MRCNN_2X` = `MRCNN-2X`,
    `FPN2-WS_0.125X` = `FPN2-WS-0.125X`,
    `FPN2-WS_0.25X` = `FPN2-WS-0.25X`,
    `FPN2-WS_0.5X` = `FPN2-WS-0.5X`,
    `FPN2-WS_1X` = `FPN2-WS-1X`,
    `FPN2-WS_2X` = `FPN2-WS-2X`
  ) %>%
  pivot_longer(
    cols = -`Cell Line`,
    names_sep = "_",
    names_to = c("Model", "Set Size"),
    values_to = "F1 Score"
  ) %>%
  pivot_wider(
    names_from = `Cell Line`,
    values_from = `F1 Score`,
  ) %>%
  arrange(Model, `Set Size`)
```

Same as above, but for Table 6.
```{r reformat-table6}
levs3 <- c("Full",
           "Min-Blur",
           "Min-Contr",
           "Min-Noise",
           "Min-Scaling",
           "None")

table_6_reformat <- table_6 %>%
    select(`Cell Line` = cell_line,
           `MRCNN_Full` = `MRCNN-Full`,
           `MRCNN_Min-Blur` = `MRCNN-Min_Blur`,
           `MRCNN_Min-Contr` = `MRCNN-Min_Contr`,
           `MRCNN_Min-Noise` = `MRCNN-Min_Noise`,
           `MRCNN_Min-Scaling` = `MRCNN-Min_Scaling`,
           `MRCNN_None` = `MRCNN-None`,
           `FPN2-WS_Full` = `FPN2-WS-Full`,
           `FPN2-WS_Min-Blur` = `FPN2-WS-Min_Blur`,
           `FPN2-WS_Min-Contr` = `FPN2-WS-Min_Contr`,
           `FPN2-WS_Min-Noise` = `FPN2-WS-Min_Noise`,
           `FPN2-WS_Min-Scaling` = `FPN2-WS-Min_Scaling`,
           `FPN2-WS_None` = `FPN2-WS-None`
           ) %>%
    pivot_longer(cols = -`Cell Line`,
                 names_sep = "_",
                 names_to = c("Model", "Augmentation"),
                 values_to = "F1 Score") %>%
    pivot_wider(names_from = `Cell Line`,
                values_from = `F1 Score`) %>%
    mutate(Augmentation = factor(Augmentation, levels = levs3)) %>%
    arrange(Model, Augmentation)
```

Same as above, but for Table 7.
```{r reformat-table7}
levs3 <- c("MCF10A", "U2OS", "HCT116", "Eosinophils")
levs4 <- c("None", "Full")

table_7_reformat <- table_7 %>%
    select(`Cell Line` = cell_line,
           Model = model,
           Initialization = initialization,
           Augmentation = aug,
           F1_mean
           ) %>%
    pivot_wider(names_from = `Cell Line`,
                values_from = `F1_mean`) %>%
    mutate( Augmentation = factor(Augmentation, levels = levs4),
           Initialization = factor(Initialization, levels = levs1)) %>%
    arrange(Model, 
            Initialization, 
            Augmentation)
```

Same as above, but for Table 8.
```{r reformat-table8}
table_8_reformat <- table_8 %>%
    rename(`Cell Line` = cell_line, 
           `MRCNN_0.7` = `MRCNN-0.7`,
           `MRCNN_0.9` = `MRCNN-0.9`,
           `FPN2-WS_0.7` = `FPN2-WS-0.7`,
           `FPN2-WS_0.9` = `FPN2-WS-0.9`,
           Jacobkie_0.7 = `Jacobkie-0.7`,
           Jacobkie_0.9 = `Jacobkie-0.9`,
           ) %>%
    pivot_longer(cols = -`Cell Line`,
                 names_sep = "_",
                 names_to = c("Model", "Threshold"),
                 values_to = "F1 Score") %>%
    pivot_wider(names_from = c(`Cell Line`, `Threshold`),
                values_from = `F1 Score`,
                names_sep = "/")
```

Same as above, but for Table S3.
```{r reformat-tableS2}
table_S3_reformat <- table_S3 %>%
    rename(`Cell Line` = cell_line,
           `MRCNN/Manual_0.7` = `MRCNN-Manual-0.7`,
           `MRCNN/SemiAutomated_0.7` = `MRCNN-Semi-Automated-0.7`,
           `MRCNN/Manual_0.9` = `MRCNN-Manual-0.9`,
           `MRCNN/SemiAutomated_0.9` = `MRCNN-Semi-Automated-0.9`,
           `FPN2-WS/Manual_0.7` = `FPN2-WS-Manual-0.7`,
           `FPN2-WS/SemiAutomated_0.7` = `FPN2-WS-Semi-Automated-0.7`,
           `FPN2-WS/Manual_0.9` = `FPN2-WS-Manual-0.9`,
           `FPN2-WS/SemiAutomated_0.9` = `FPN2-WS-Semi-Automated-0.9`,
           `Jacobkie/Manual_0.7` = `Jacobkie-Manual-0.7`,
           `Jacobkie/SemiAutomated_0.7` = `Jacobkie-Semi-Automated-0.7`,
           `Jacobkie/Manual_0.9` = `Jacobkie-Manual-0.9`,
           `Jacobkie/SemiAutomated_0.9` = `Jacobkie-Semi-Automated-0.9`,
           ) %>%
    pivot_longer(cols = -`Cell Line`,
                 names_sep = "_",
                 names_to = c("Model", "Threshold"),
                 values_to = "F1 Score") %>%
    separate(col = Model,
             into = c("Model", "GT Annotation"),
             sep = "/") %>%
    pivot_wider(names_from = c(`Cell Line`, `Threshold`),
                values_from = `F1 Score`,
                names_sep = "/")
```

Same as above, but for Table S3.
```{r reformat-tableS3}
levs5 <- c("Training", "Testing")

table_S4_reformat <- table_S4 %>%
    rename(`Cell Line` = cell_line,
           `MRCNN/Training_0.7` = `MRCNN-Training-0.7`,
           `MRCNN/Testing_0.7` = `MRCNN-Testing-0.7`,
           `MRCNN/Training_0.9` = `MRCNN-Training-0.9`,
           `MRCNN/Testing_0.9` = `MRCNN-Testing-0.9`,
           `FPN2-WS/Training_0.7` = `FPN2-WS-Training-0.7`,
           `FPN2-WS/Testing_0.7` = `FPN2-WS-Testing-0.7`,
           `FPN2-WS/Training_0.9` = `FPN2-WS-Training-0.9`,
           `FPN2-WS/Testing_0.9` = `FPN2-WS-Testing-0.9`,
           ) %>%
    pivot_longer(cols = -`Cell Line`,
                 names_sep = "_",
                 names_to = c("Model", "Threshold"),
                 values_to = "F1 Score") %>%
    separate(col = Model,
             into = c("Model", "Inference Set"),
             sep = "/") %>%
    pivot_wider(names_from = c(`Cell Line`, `Threshold`),
                values_from = `F1 Score`,
                names_sep = "/") %>%
    mutate(`Inference Set` = factor(`Inference Set`, levels = levs5)) %>%
    arrange(Model, `Inference Set`)
```

### Generate Tables
Generate Table 1
```{r, print-table }
print_table <- function(df, start, end, bld = 1){
  
  df %>%
    mutate(across({{start}}:{{end}}, ~ cell_spec(round(.x, 2),
                                                              "html",
                                                              bold = .x == max(.x)))) %>% kable(format = "html",
      escape = F) %>%
   kable_styling(bootstrap_options = "striped", 
                 full_width = F,
                 position = "center") %>%
  column_spec(bld, bold = T)
}
```

```{r, label = 'Table 1'}
print_table(table_1_reformat, `MCF10A/0.7`, `Eosinophils/0.9`, 1)
```

```{r, label = 'Table 2'}
print_table(table_2_reformat, `MCF10A`, `Eosinophils`, 1)
```

```{r, label = 'Table 3'}
print_table(table_3_reformat, `MCF10A`, `Eosinophils`, 1)
```

```{r, label = 'Table 4'}
print_table(table_4_reformat, `MCF10A`, `Eosinophils`, 1)
```

```{r, label = 'Table 5'}
print_table(table_5_reformat, `MCF10A`, `Eosinophils`, 1)
```

```{r, label = 'Table 6'}
print_table(table_6_reformat, `MCF10A`, `Eosinophils`, 1)
```

```{r, label = 'Table 7'}
print_table(table_7_reformat, `MCF10A`, `Eosinophils`, 1)
```

```{r, label = 'Table 8'}
print_table(table_8_reformat, `MCF10A/0.7`, `Eosinophils/0.9`, 1)
```

```{r, fig.width=12, label = 'Table S1'}
table_S1 %>%
 kable(format = "html",
       escape = F) %>%
   kable_styling(bootstrap_options = "striped", 
                 full_width = T,
                 position = "center",
                 font_size = 10) %>%
   row_spec(1, bold = T) %>%
   column_spec(1, bold = T)
```

```{r, label = 'Table S3'}
print_table(table_S3_reformat, `MCF10A/0.7`, `Eosinophils/0.9`, 1)
```

```{r, label = 'Table S4'}
print_table(table_S4_reformat, `MCF10A/0.7`, `Eosinophils/0.9`, 1)
```

```{r sessionInfo, results='markup'}
sessionInfo()
```